<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lifting Tracker (A-Upper / A-Lower)</title>
<style>
  :root { 
    --bg: #0f1115; 
    --card: #171a21; 
    --muted: #8b95a7; 
    --text: #e7ecf3; 
    --accent: #71a8ff; 
    --good: #37d67a; 
    --bad: #ff5f57; 
  }
  * { box-sizing: border-box; }
  body { 
    margin: 0; 
    font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial; 
    background: var(--bg); 
    color: var(--text); 
  }
  header { 
    position: sticky; 
    top: 0; 
    background: rgba(15,17,21,.8); 
    backdrop-filter: blur(10px); 
    border-bottom: 1px solid #222; 
    padding: 10px 14px; 
    display: flex; 
    gap: 10px; 
    align-items: center; 
    z-index: 2; 
  }
  h1 { font-size: 18px; margin: 0 6px 0 0; }
  main { padding: 14px; max-width: 980px; margin: 0 auto; }
  .tabs { display: flex; gap: 8px; flex-wrap: wrap; }
  .tab { 
    padding: 8px 12px; 
    border: 1px solid #2a2f3a; 
    border-radius: 999px; 
    color: var(--muted); 
    cursor: pointer; 
    background: none;
  }
  .tab.active { 
    background: var(--accent); 
    border-color: var(--accent); 
    color: #081020; 
  }
  .row { display: flex; gap: 10px; flex-wrap: wrap; }
  .card { 
    background: var(--card); 
    border: 1px solid #222; 
    border-radius: 16px; 
    padding: 12px; 
    margin-bottom: 12px;
  }
  label { 
    font-size: 12px; 
    color: var(--muted); 
    display: block; 
    margin-bottom: 4px; 
  }
  input, select, button, textarea { 
    background: #0f1218; 
    color: var(--text); 
    border: 1px solid #2a2f3a; 
    border-radius: 10px; 
    padding: 8px 10px; 
  }
  input:focus, select:focus, textarea:focus { 
    outline: 1px solid var(--accent); 
  }
  button { cursor: pointer; }
  button:hover { background: #1a1d24; }
  table { width: 100%; border-collapse: collapse; font-size: 14px; }
  th, td { padding: 8px; border-bottom: 1px solid #262a33; }
  .tiny { font-size: 12px; color: var(--muted); }
  .pill { 
    display: inline-block; 
    padding: 2px 8px; 
    border-radius: 999px; 
    border: 1px solid #2a2f3a; 
    color: var(--muted); 
    font-size: 12px; 
  }
  .good { color: var(--good); }
  .bad { color: var(--bad); }
  .grid { display: grid; gap: 10px; }
  .file-input { position: relative; }
  .file-input input[type="file"] { 
    position: absolute; 
    opacity: 0; 
    width: 100%; 
    height: 100%; 
    cursor: pointer; 
  }
  @media(min-width: 700px) { 
    .grid-2 { grid-template-columns: 1fr 1fr; } 
    .grid-3 { grid-template-columns: repeat(3, 1fr); } 
  }
</style>
</head>
<body>
<header>
  <h1>LiftTracker</h1>
  <div class="tabs">
    <button class="tab active" data-page="today">Today</button>
    <button class="tab" data-page="templates">Templates</button>
    <button class="tab" data-page="exercises">Exercises</button>
    <button class="tab" data-page="history">History</button>
    <button class="tab" data-page="settings">Settings</button>
    <button class="tab" data-page="rpe-schedule">RPE Schedule</button>
    <button class="tab" data-page="rep-progression">Rep Progression</button>
  </div>
  <div style="margin-left: auto;" class="row">
    <button id="exportBtn">Export</button>
    <div class="file-input pill">
      <input type="file" id="importFile" accept=".json">
      Import
    </div>
  </div>
</header>

<main>
  <!-- TODAY -->
  <section id="page-today">
    <div class="row">
      <div class="card">
        <label>Week (1–6)</label>
        <input id="week" type="number" min="1" max="6" value="1" style="width: 90px;">
      </div>
      <div class="card">
        <label>Day</label>
        <select id="day"></select>
      </div>
      <div class="card">
        <label>&nbsp;</label>
        <button id="advanceBtn">Advance Week/Day</button>
      </div>
      <div class="card">
        <label>Unit</label>
        <select id="unit">
          <option value="lb">lb</option>
          <option value="kg">kg</option>
        </select>
      </div>
    </div>

    <div class="card">
      <div class="row" style="align-items: center; justify-content: space-between;">
        <div>
          <strong id="todayTitle">Week 1 - A Upper</strong>
          <div class="tiny">Prescriptions are TM × %1RM (RPE chart) → rounded to plates.</div>
        </div>
        <button id="closeWeekBtn">Close Week (progress TMs)</button>
      </div>
      <div id="todayList" style="margin-top: 10px;"></div>
    </div>
  </section>

  <!-- TEMPLATES -->
  <section id="page-templates" hidden>
    <div class="grid grid-2">
      <div class="card">
        <h3>A-Upper Template</h3>
        <div id="tmpl-a-upper"></div>
        <button onclick="addTemplateRow('A-Upper')">+ Add Exercise</button>
      </div>
      <div class="card">
        <h3>A-Lower Template</h3>
        <div id="tmpl-a-lower"></div>
        <button onclick="addTemplateRow('A-Lower')">+ Add Exercise</button>
      </div>
      <div class="card">
        <h3>B-Upper Template</h3>
        <div id="tmpl-b-upper"></div>
        <button onclick="addTemplateRow('B-Upper')">+ Add Exercise</button>
      </div>
      <div class="card">
        <h3>B-Lower Template</h3>
        <div id="tmpl-b-lower"></div>
        <button onclick="addTemplateRow('B-Lower')">+ Add Exercise</button>
      </div>
    </div>
    <button id="resetBtn">Reset Templates</button>
  </section>

  <!-- EXERCISES -->
  <section id="page-exercises" hidden>
    <div class="card">
      <h3>Add Exercise</h3>
      <div class="row">
        <div><label>Name</label><input id="exName"></div>
        <div>
          <label>Category</label>
          <select id="exCat">
            <option>CHEST</option>
            <option>BACK</option>
            <option>QUADS</option>
            <option>HAMSTRINGS</option>
            <option>SHOULDERS</option>
            <option>ARMS</option>
          </select>
        </div>
        <div><label>Training Max</label><input id="exTM" type="number" step="0.5"></div>
        <div><label>Min Reps</label><input id="exMinReps" type="number" min="1" max="20" value="3"></div>
        <div><label>Max Reps</label><input id="exMaxReps" type="number" min="1" max="20" value="10"></div>
        <div><label>&nbsp;</label><button onclick="addExercise()">Add</button></div>
      </div>
    </div>
    <div class="card">
      <h3>Exercises</h3>
      <table id="exTable">
        <thead>
          <tr><th>Name</th><th>Category</th><th>TM</th><th>Rep Range</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- HISTORY -->
  <section id="page-history" hidden>
    <div class="card">
      <h3>Recent Sets</h3>
      <table id="logTable">
        <thead>
          <tr><th>Date</th><th>Exercise</th><th>W×R@RPE</th><th>e1RM</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="page-settings" hidden>
    <div class="grid grid-2">
      <div class="card">
        <h3>Progression (weekly TM)</h3>
        <p class="tiny">Score = +1 set hit at/under target RPE, +0.5 if +0.5 over, −1 if miss or ≥ +1 RPE over.</p>
        <div class="grid grid-3">
          <div><label>Upper up (strong)</label><input id="upUpperStrong" type="number" step="0.1" value="1.5"> %</div>
          <div><label>Upper up (solid)</label><input id="upUpperSmall" type="number" step="0.1" value="0.5"> %</div>
          <div><label>Upper down (struggle)</label><input id="downUpper" type="number" step="0.1" value="2.5"> %</div>
          <div><label>Lower up (strong)</label><input id="upLowerStrong" type="number" step="0.1" value="1.5"> %</div>
          <div><label>Lower up (solid)</label><input id="upLowerSmall" type="number" step="0.1" value="1.0"> %</div>
          <div><label>Lower down (struggle)</label><input id="downLower" type="number" step="0.1" value="2.5"> %</div>
        </div>
        <p class="tiny">Cap TM ≤ 97.5% of best rolling e1RM; floor ≥ 85%.</p>
        <button onclick="saveSettings()">Save Settings</button>
      </div>
      <div class="card">
        <h3>Plate Rounding</h3>
        <label>Min per-side plate (lb or kg)</label>
        <input id="minJump" type="number" step="0.25" value="2.5">
      </div>
    </div>
  </section>

  <!-- RPE SCHEDULE -->
  <section id="page-rpe-schedule" hidden>
    <div class="card">
      <div class="row" style="justify-content: space-between; align-items: center;">
        <h3>RPE Schedule by Week/Section/Body Part</h3>
        <button onclick="resetRPESchedule()">Reset to Default</button>
      </div>
      <p class="tiny">Customize RPE targets for each body part by week and section (A/B). This overrides template RPE values.</p>
      
      <div class="grid grid-2" style="margin-bottom: 20px;">
        <div class="card">
          <h4>Quick Presets</h4>
          <div class="row">
            <button onclick="applyLinearProgression()">Linear (8→9.5)</button>
            <button onclick="applyWaveProgression()">Wave (8→9→8.5→9.5)</button>
            <button onclick="applyBlockProgression()">Block (2wk cycles)</button>
          </div>
        </div>
        <div class="card">
          <h4>Add New Override</h4>
          <div class="row">
            <div><label>Week</label><select id="newWeek"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select></div>
            <div><label>Section</label><select id="newSection"><option>A</option><option>B</option></select></div>
            <div><label>Body Part</label><select id="newBodyPart"><option>CHEST</option><option>BACK</option><option>QUADS</option><option>HAMSTRINGS</option><option>SHOULDERS</option><option>ARMS</option></select></div>
            <div><label>RPE</label><input id="newRPE" type="number" step="0.5" min="6" max="10" value="8.0"></div>
            <div><label>&nbsp;</label><button onclick="addRPEOverride()">Add</button></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h4>Current RPE Schedule</h4>
        <div style="overflow-x: auto;">
          <table id="rpeScheduleTable">
            <thead>
              <tr>
                <th>Body Part</th>
                <th>W1-A</th><th>W1-B</th>
                <th>W2-A</th><th>W2-B</th>
                <th>W3-A</th><th>W3-B</th>
                <th>W4-A</th><th>W4-B</th>
                <th>W5-A</th><th>W5-B</th>
                <th>W6-A</th><th>W6-B</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h4>Individual Overrides</h4>
        <table id="rpeOverrideTable">
          <thead>
            <tr><th>Week</th><th>Section</th><th>Body Part</th><th>RPE</th><th>Actions</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- REP PROGRESSION -->
  <section id="page-rep-progression" hidden>
    <div class="card">
      <div class="row" style="justify-content: space-between; align-items: center;">
        <h3>Rep Progression by Week/Section/Body Part</h3>
        <button onclick="resetRepProgression()">Reset to Default</button>
      </div>
      <p class="tiny">Set rep percentages (0.0-1.0) for each body part by week and section. Reps are calculated as: percentage × (maxReps - minReps) + minReps.</p>
      
      <div class="grid grid-2" style="margin-bottom: 20px;">
        <div class="card">
          <h4>Quick Presets</h4>
          <div class="row">
            <button onclick="applyLinearRepProgression()">Linear (1.0→0.0)</button>
            <button onclick="applyWaveRepProgression()">Wave (high→low→mid)</button>
            <button onclick="applyBlockRepProgression()">Block (2wk cycles)</button>
          </div>
        </div>
        <div class="card">
          <h4>Add New Override</h4>
          <div class="row">
            <div><label>Week</label><select id="newRepWeek"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select></div>
            <div><label>Section</label><select id="newRepSection"><option>A</option><option>B</option></select></div>
            <div><label>Body Part</label><select id="newRepBodyPart"><option>CHEST</option><option>BACK</option><option>QUADS</option><option>HAMSTRINGS</option><option>SHOULDERS</option><option>ARMS</option></select></div>
            <div><label>Percentage</label><input id="newRepPercentage" type="number" step="0.1" min="0" max="1" value="0.5"></div>
            <div><label>&nbsp;</label><button onclick="addRepPercentageOverride()">Add</button></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h4>Current Rep Progression Schedule</h4>
        <div style="overflow-x: auto;">
          <table id="repProgressionTable">
            <thead>
              <tr>
                <th>Body Part</th>
                <th>W1-A</th><th>W1-B</th>
                <th>W2-A</th><th>W2-B</th>
                <th>W3-A</th><th>W3-B</th>
                <th>W4-A</th><th>W4-B</th>
                <th>W5-A</th><th>W5-B</th>
                <th>W6-A</th><th>W6-B</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h4>Individual Overrides</h4>
        <table id="repOverrideTable">
          <thead>
            <tr><th>Week</th><th>Section</th><th>Body Part</th><th>Percentage</th><th>Actions</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<script>
/* ---------- Constants and State ---------- */
const STORE_KEY = 'lifttracker_v1';

// RPE to %1RM conversion table
const RPE_TABLE = {
  3: { 8.0: 0.89, 8.5: 0.90, 9.0: 0.92 },
  4: { 8.0: 0.86, 8.5: 0.87, 9.0: 0.89 },
  5: { 8.0: 0.83, 8.5: 0.85, 9.0: 0.86 },
  6: { 8.0: 0.81, 8.5: 0.82, 9.0: 0.84 },
  8: { 8.0: 0.76, 8.5: 0.78, 9.0: 0.80 },
  10: { 8.0: 0.72, 8.5: 0.74, 9.0: 0.76 }
};

// Body part categories
const BODY_PARTS = ['CHEST', 'BACK', 'QUADS', 'HAMSTRINGS', 'SHOULDERS', 'ARMS'];

// Default state
const DEFAULT_STATE = {
  unit: 'lb',
  settings: {
    upUpperStrong: 1.5,
    upUpperSmall: 0.5,
    downUpper: 2.5,
    upLowerStrong: 1.5,
    upLowerSmall: 1.0,
    downLower: 2.5,
    minJump: 2.5
  },
  exercises: [
    { id: 1, name: 'Barbell Bench Press', cat: 'CHEST', tm: 185 },
    { id: 2, name: 'Back Squat', cat: 'QUADS', tm: 275 },
    { id: 3, name: 'Barbell Row', cat: 'BACK', tm: 185 },
    { id: 4, name: 'RDL', cat: 'HAMSTRINGS', tm: 225 }
  ],
  nextId: 5,
  templates: {
    'A-Upper': [
      { exId: 1, reps: 5, rpe: 8.5, sets: 4 },
      { exId: 3, reps: 6, rpe: 8.0, sets: 3 }
    ],
    'A-Lower': [
      { exId: 2, reps: 5, rpe: 8.5, sets: 4 },
      { exId: 4, reps: 6, rpe: 8.0, sets: 3 }
    ],
    'B-Upper': [
      { exId: 1, reps: 4, rpe: 8.0, sets: 3 },
      { exId: 3, reps: 5, rpe: 8.0, sets: 3 }
    ],
    'B-Lower': [
      { exId: 2, reps: 4, rpe: 8.0, sets: 3 },
      { exId: 4, reps: 5, rpe: 8.0, sets: 3 }
    ]
  },
  // RPE Schedule System
  rpeSchedule: {
    // Format: "week-section-bodypart": rpe
    overrides: {},
    // Default RPE values when no override exists
    defaults: {
      'CHEST': 8.5,
      'BACK': 8.0,
      'QUADS': 8.5,
      'HAMSTRINGS': 8.0,
      'SHOULDERS': 8.0,
      'ARMS': 8.0
    }
  },
  // Rep Progression System
  repProgression: {
    // Format: "week-section-bodypart": percentage (0-1)
    overrides: {},
    // Default rep percentages when no override exists
    defaults: {
      'CHEST': 0.5,
      'BACK': 0.5,
      'QUADS': 0.5,
      'HAMSTRINGS': 0.5,
      'SHOULDERS': 0.5,
      'ARMS': 0.5
    }
  },
  // Exercise rep ranges (min-max reps for each exercise)
  exerciseRepRanges: {},
  log: []
};

// Load or initialize state
let state = JSON.parse(localStorage.getItem(STORE_KEY)) || JSON.parse(JSON.stringify(DEFAULT_STATE));

// Ensure RPE schedule exists in loaded state (for backwards compatibility)
if (!state.rpeSchedule) {
  state.rpeSchedule = JSON.parse(JSON.stringify(DEFAULT_STATE.rpeSchedule));
}

// Ensure rep progression exists in loaded state (for backwards compatibility)
if (!state.repProgression) {
  state.repProgression = JSON.parse(JSON.stringify(DEFAULT_STATE.repProgression));
}

// Ensure exercise rep ranges exist (for backwards compatibility)
if (!state.exerciseRepRanges) {
  state.exerciseRepRanges = {};
}

/* ---------- Utility Functions ---------- */
function persist() {
  localStorage.setItem(STORE_KEY, JSON.stringify(state));
}

function $(selector) {
  return document.querySelector(selector);
}

function fmt(number) {
  return Number(number).toFixed(0);
}

function isLowerBody(category) {
  return category === 'QUADS' || category === 'HAMSTRINGS';
}

/* ---------- Rep Progression Functions ---------- */
function getRepPercentageForExercise(week, section, bodyPart) {
  const key = `${week}-${section}-${bodyPart}`;
  
  // Check for specific override first
  if (state.repProgression.overrides[key] !== undefined) {
    return state.repProgression.overrides[key];
  }
  
  // Fall back to default for body part
  return state.repProgression.defaults[bodyPart] || 0.5;
}

function setRepPercentageOverride(week, section, bodyPart, percentage) {
  const key = `${week}-${section}-${bodyPart}`;
  state.repProgression.overrides[key] = percentage;
  persist();
}

function removeRepPercentageOverride(week, section, bodyPart) {
  const key = `${week}-${section}-${bodyPart}`;
  delete state.repProgression.overrides[key];
  persist();
}

function getExerciseRepRange(exerciseId) {
  return state.exerciseRepRanges[exerciseId] || { min: 3, max: 10 };
}

function setExerciseRepRange(exerciseId, minReps, maxReps) {
  state.exerciseRepRanges[exerciseId] = { min: minReps, max: maxReps };
  persist();
}

function calculateTargetReps(exerciseId, week, section, bodyPart) {
  const repRange = getExerciseRepRange(exerciseId);
  const percentage = getRepPercentageForExercise(week, section, bodyPart);
  return Math.round(percentage * (repRange.max - repRange.min) + repRange.min);
}

function resetRepProgression() {
  if (confirm('Reset rep progression to defaults? This will remove all custom overrides.')) {
    state.repProgression = JSON.parse(JSON.stringify(DEFAULT_STATE.repProgression));
    persist();
    renderRepProgression();
    alert('Rep progression reset to defaults.');
  }
}

/* ---------- RPE Schedule Functions ---------- */
function getRPEForExercise(week, section, bodyPart) {
  const key = `${week}-${section}-${bodyPart}`;
  
  // Check for specific override first
  if (state.rpeSchedule.overrides[key] !== undefined) {
    return state.rpeSchedule.overrides[key];
  }
  
  // Fall back to default for body part
  return state.rpeSchedule.defaults[bodyPart] || 8.0;
}

function setRPEOverride(week, section, bodyPart, rpe) {
  const key = `${week}-${section}-${bodyPart}`;
  state.rpeSchedule.overrides[key] = rpe;
  persist();
}

function removeRPEOverride(week, section, bodyPart) {
  const key = `${week}-${section}-${bodyPart}`;
  delete state.rpeSchedule.overrides[key];
  persist();
}

function applyLinearProgression() {
  // Linear progression from week 1 to 6: 8.0 → 9.5
  state.rpeSchedule.overrides = {};
  
  for (let week = 1; week <= 6; week++) {
    for (const section of ['A', 'B']) {
      for (const bodyPart of BODY_PARTS) {
        const rpe = 8.0 + ((week - 1) * 0.3); // Increases by 0.3 each week
        setRPEOverride(week, section, bodyPart, Math.round(rpe * 2) / 2); // Round to nearest 0.5
      }
    }
  }
  renderRPESchedule();
  alert('Applied Linear Progression (8.0 → 9.5)');
}

function applyWaveProgression() {
  // Wave progression: 8.0 → 9.0 → 8.5 → 9.5 → 8.0 → 9.0
  const waves = [8.0, 9.0, 8.5, 9.5, 8.0, 9.0];
  state.rpeSchedule.overrides = {};
  
  for (let week = 1; week <= 6; week++) {
    for (const section of ['A', 'B']) {
      for (const bodyPart of BODY_PARTS) {
        setRPEOverride(week, section, bodyPart, waves[week - 1]);
      }
    }
  }
  renderRPESchedule();
  alert('Applied Wave Progression');
}

function applyBlockProgression() {
  // Block progression: 2 weeks at each intensity
  const blocks = [8.0, 8.0, 8.5, 8.5, 9.0, 9.0];
  state.rpeSchedule.overrides = {};
  
  for (let week = 1; week <= 6; week++) {
    for (const section of ['A', 'B']) {
      for (const bodyPart of BODY_PARTS) {
        setRPEOverride(week, section, bodyPart, blocks[week - 1]);
      }
    }
  }
  renderRPESchedule();
  alert('Applied Block Progression (2-week blocks)');
}

function resetRPESchedule() {
  if (confirm('Reset RPE schedule to defaults? This will remove all custom overrides.')) {
    state.rpeSchedule = JSON.parse(JSON.stringify(DEFAULT_STATE.rpeSchedule));
    persist();
    renderRPESchedule();
    alert('RPE schedule reset to defaults.');
  }
}

function applyLinearRepProgression() {
  // Linear progression from week 1 to 6: 1.0 → 0.0 (high reps to low reps)
  state.repProgression.overrides = {};
  
  for (let week = 1; week <= 6; week++) {
    for (const section of ['A', 'B']) {
      for (const bodyPart of BODY_PARTS) {
        const percentage = 1.0 - ((week - 1) * 0.2); // Decreases by 0.2 each week
        setRepPercentageOverride(week, section, bodyPart, Math.max(0, Math.round(percentage * 10) / 10)); // Round to nearest 0.1
      }
    }
  }
  renderRepProgression();
  alert('Applied Linear Rep Progression (1.0 → 0.0)');
}

function applyWaveRepProgression() {
  // Wave progression: high → low → mid → lower → high → low
  const waves = [1.0, 0.2, 0.6, 0.1, 0.8, 0.3];
  state.repProgression.overrides = {};
  
  for (let week = 1; week <= 6; week++) {
    for (const section of ['A', 'B']) {
      for (const bodyPart of BODY_PARTS) {
        setRepPercentageOverride(week, section, bodyPart, waves[week - 1]);
      }
    }
  }
  renderRepProgression();
  alert('Applied Wave Rep Progression');
}

function applyBlockRepProgression() {
  // Block progression: 2 weeks at each rep range
  const blocks = [0.8, 0.8, 0.5, 0.5, 0.2, 0.2];
  state.repProgression.overrides = {};
  
  for (let week = 1; week <= 6; week++) {
    for (const section of ['A', 'B']) {
      for (const bodyPart of BODY_PARTS) {
        setRepPercentageOverride(week, section, bodyPart, blocks[week - 1]);
      }
    }
  }
  renderRepProgression();
  alert('Applied Block Rep Progression (2-week blocks)');
}

/* ---------- Calculation Functions ---------- */
function calculateE1RM(weight, reps) {
  if (reps <= 7) {
    return weight * (1 + 0.0333 * reps);
  }
  return weight * Math.pow(reps, 0.1);
}

function roundToPlates(target, unit, minJump) {
  const jump = minJump || (unit === 'lb' ? 2.5 : 1.25);
  const plateWeight = jump * 2; // Both sides of barbell
  return Math.round(target / plateWeight) * plateWeight;
}

function prescribeLoad(trainingMax, reps, rpe, unit, minJump) {
  const percentage = RPE_TABLE[reps]?.[rpe];
  if (!percentage) return 0;
  
  const prescribedWeight = trainingMax * percentage;
  return roundToPlates(prescribedWeight, unit, minJump);
}

function applyDeload(week, load, sets) {
  if (week === 6) {
    return [load * 0.875, Math.max(1, sets - 1)];
  }
  return [load, sets];
}

function getNextSetAdjustment(targetRpe, actualRpe, repsCompleted, targetReps) {
  if (!repsCompleted || repsCompleted < targetReps || actualRpe >= targetRpe + 1.0) {
    return 0.95; // Reduce weight
  }
  if (actualRpe <= targetRpe - 1.0) {
    return 1.025; // Increase weight
  }
  return 1.0; // Maintain weight
}

function getBestRollingE1RM(exerciseId, days = 42) {
  const cutoffDate = Date.now() - days * 86400000;
  let bestE1RM = 0;
  
  for (const set of state.log) {
    if (set.exId === exerciseId && new Date(set.date).getTime() >= cutoffDate) {
      bestE1RM = Math.max(bestE1RM, set.e1rm);
    }
  }
  
  return bestE1RM;
}

function progressTrainingMax(exercise) {
  const cutoffDate = Date.now() - 7 * 86400000;
  let score = 0;
  let bestWeeklyE1RM = 0;
  
  // Calculate weekly performance score
  for (const set of state.log) {
    if (set.exId !== exercise.id) continue;
    if (new Date(set.date).getTime() < cutoffDate) continue;
    
    // Use target RPE if available, otherwise fall back to simple RPE scoring
    const targetRPE = set.targetRpe || 8.5;
    const rpeDelta = set.rpe - targetRPE;
    
    let rpeScore = 0;
    if (rpeDelta >= 1.0) {
      rpeScore = -1; // Much harder than target
    } else if (rpeDelta >= 0.5) {
      rpeScore = 0.5; // Slightly harder than target
    } else if (rpeDelta <= -1.0) {
      rpeScore = 1; // Much easier than target
    } else {
      rpeScore = 1; // Hit target
    }
    
    score += rpeScore;
    bestWeeklyE1RM = Math.max(bestWeeklyE1RM, set.e1rm);
  }
  
  // Get progression rates based on body part
  const settings = state.settings;
  const isLower = isLowerBody(exercise.cat);
  const strongUp = isLower ? settings.upLowerStrong : settings.upUpperStrong;
  const smallUp = isLower ? settings.upLowerSmall : settings.upUpperSmall;
  const down = isLower ? settings.downLower : settings.downUpper;
  
  // Calculate new TM based on score
  let newTM = exercise.tm;
  if (score >= 2) {
    newTM = exercise.tm * (1 + strongUp / 100);
  } else if (score >= 0.5) {
    newTM = exercise.tm * (1 + smallUp / 100);
  } else if (score <= -1) {
    newTM = exercise.tm * (1 - down / 100);
  }
  
  // Apply safety bounds
  const referenceMax = Math.max(getBestRollingE1RM(exercise.id), bestWeeklyE1RM, exercise.tm);
  const cap = referenceMax * 0.975;
  const floor = referenceMax * 0.85;
  
  exercise.tm = Math.min(Math.max(newTM, floor), cap) || exercise.tm;
}

/* ---------- Day Management ---------- */
function updateDayDropdown() {
  const week = Number($('#week').value) || 1;
  const daySelect = $('#day');
  daySelect.innerHTML = '';
  
  const days = [
    { value: `${week}-A-upper`, label: `Week ${week} - A Upper` },
    { value: `${week}-A-lower`, label: `Week ${week} - A Lower` },
    { value: `${week}-B-upper`, label: `Week ${week} - B Upper` },
    { value: `${week}-B-lower`, label: `Week ${week} - B Lower` }
  ];
  
  days.forEach(day => {
    const option = document.createElement('option');
    option.value = day.value;
    option.textContent = day.label;
    daySelect.appendChild(option);
  });
}

function getTemplateKeyFromDayValue(dayValue) {
  const [week, part, split] = dayValue.split('-');
  return `${part}-${split.charAt(0).toUpperCase() + split.slice(1)}`;
}

function getCurrentDayIndex() {
  const week = Number($('#week').value);
  const dayValue = $('#day').value;
  const days = [`${week}-A-upper`, `${week}-A-lower`, `${week}-B-upper`, `${week}-B-lower`];
  return days.indexOf(dayValue);
}

function advanceDay() {
  let week = Number($('#week').value);
  let currentIndex = getCurrentDayIndex();
  
  if (currentIndex === 3) { // Last day (B Lower)
    week = week === 6 ? 1 : week + 1;
    $('#week').value = week;
    updateDayDropdown();
    $('#day').value = `${week}-A-upper`;
  } else {
    currentIndex++;
    const days = [`${week}-A-upper`, `${week}-A-lower`, `${week}-B-upper`, `${week}-B-lower`];
    $('#day').value = days[currentIndex];
  }
  
  renderToday();
}

/* ---------- Rendering Functions ---------- */
function renderTabs() {
  document.querySelectorAll('.tab').forEach(button => {
    button.onclick = () => {
      // Update active tab
      document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
      button.classList.add('active');
      
      // Show corresponding page
      const page = button.dataset.page;
      document.querySelectorAll('main section').forEach(section => section.hidden = true);
      $(`#page-${page}`).hidden = false;
      
      // Render page content
      switch (page) {
        case 'today': renderToday(); break;
        case 'templates': renderTemplates(); break;
        case 'exercises': renderExercises(); break;
        case 'history': renderHistory(); break;
        case 'settings': renderSettings(); break;
        case 'rpe-schedule': renderRPESchedule(); break;
        case 'rep-progression': renderRepProgression(); break;
      }
    };
  });
}

function renderToday() {
  $('#unit').value = state.unit;
  
  const week = Number($('#week').value) || 1;
  const dayValue = $('#day').value;
  const templateKey = getTemplateKeyFromDayValue(dayValue);
  const section = templateKey.split('-')[0]; // 'A' or 'B'
  
  $('#todayTitle').textContent = `Week ${week} - ${templateKey.replace('-', ' ')}`;
  
  const container = $('#todayList');
  container.innerHTML = '';
  
  const templateItems = state.templates[templateKey] || [];
  
  if (templateItems.length === 0) {
    container.innerHTML = '<div class="tiny">No exercises in this template yet.</div>';
    return;
  }
  
  templateItems.forEach(item => {
    const exercise = state.exercises.find(ex => ex.id === item.exId);
    if (!exercise) return;
    
    // Get RPE from schedule (overrides template RPE)
    const scheduledRPE = getRPEForExercise(week, section, exercise.cat);
    
    // Get target reps from rep progression
    const targetReps = calculateTargetReps(exercise.id, week, section, exercise.cat);
    
    let prescribedLoad = prescribeLoad(exercise.tm, targetReps, scheduledRPE, state.unit, state.settings.minJump);
    let prescribedSets = item.sets;
    
    // Apply deload if week 6
    [prescribedLoad, prescribedSets] = applyDeload(week, prescribedLoad, prescribedSets);
    
    const exerciseCard = document.createElement('div');
    exerciseCard.className = 'card';
    exerciseCard.innerHTML = `
      <div class="row" style="justify-content: space-between; align-items: center;">
        <div>
          <div><strong>${exercise.name}</strong> <span class="pill">${exercise.cat}</span></div>
          <div class="tiny">TM ${fmt(exercise.tm)} ${state.unit} • Expected: <b>${fmt(prescribedLoad)}</b> × ${targetReps} × ${prescribedSets} @ RPE ${scheduledRPE}${scheduledRPE !== item.rpe ? ` <span class="good">(RPE overridden from ${item.rpe})</span>` : ''}${targetReps !== item.reps ? ` <span class="good">(Reps overridden from ${item.reps})</span>` : ''}</div>
        </div>
        <div class="row">
          <div><label>Weight</label><input type="number" step="0.5" value="${fmt(prescribedLoad)}" style="width: 110px;" class="weight-input"></div>
          <div><label>Reps</label><input type="number" value="${targetReps}" style="width: 80px;" class="reps-input"></div>
          <div><label>RPE</label><input type="number" step="0.5" value="${scheduledRPE}" style="width: 80px;" class="rpe-input"></div>
          <div><label>&nbsp;</label><button class="log-btn">Add Set</button></div>
        </div>
      </div>
      <div class="tiny feedback" style="margin-top: 6px;" hidden></div>
    `;
    
    // Add event listener for logging sets
    exerciseCard.querySelector('.log-btn').onclick = () => {
      const weight = Number(exerciseCard.querySelector('.weight-input').value);
      const reps = Number(exerciseCard.querySelector('.reps-input').value);
      const rpe = Number(exerciseCard.querySelector('.rpe-input').value);
      
      if (!weight || !reps || !rpe) return;
      
      const e1rm = calculateE1RM(weight, reps);
      
      // Log the set
      state.log.unshift({
        date: new Date().toISOString(),
        exId: exercise.id,
        weight: weight,
        reps: reps,
        rpe: rpe,
        e1rm: e1rm,
        week: week,
        day: templateKey,
        targetRpe: scheduledRPE // Store target for progression analysis
      });
      
      persist();
      
      // Calculate next set suggestion using scheduled RPE as target
      const adjustmentFactor = getNextSetAdjustment(scheduledRPE, rpe, reps, targetReps);
      const nextWeight = roundToPlates(weight * adjustmentFactor, state.unit, state.settings.minJump);
      
      // Show feedback
      const feedback = exerciseCard.querySelector('.feedback');
      feedback.hidden = false;
      feedback.innerHTML = `Logged! e1RM: <b>${e1rm.toFixed(1)}</b>. Next set suggestion: <b>${fmt(nextWeight)}</b> ${state.unit}`;
      
      // Update weight input for next set
      exerciseCard.querySelector('.weight-input').value = fmt(nextWeight);
      
      renderHistory();
    };
    
    container.appendChild(exerciseCard);
  });
}

function renderTemplates() {
  const templateKeys = ['A-Upper', 'A-Lower', 'B-Upper', 'B-Lower'];
  
  templateKeys.forEach(templateKey => {
    const containerId = `tmpl-${templateKey.toLowerCase().replace('-', '-')}`;
    const container = $(`#${containerId}`);
    if (!container) return;
    
    container.innerHTML = '';
    
    const templateItems = state.templates[templateKey] || [];
    
    templateItems.forEach((item, index) => {
      const exercise = state.exercises.find(ex => ex.id === item.exId);
      
      const row = document.createElement('div');
      row.className = 'row';
      row.style.marginBottom = '8px';
      row.innerHTML = `
        <div>
          <label>Exercise</label>
          <select class="exercise-select"></select>
        </div>
        <div><label>Reps</label><input class="reps-input" type="number" value="${item.reps}" style="width: 80px;"></div>
        <div><label>RPE</label><input class="rpe-input" type="number" step="0.5" value="${item.rpe}" style="width: 80px;"></div>
        <div><label>Sets</label><input class="sets-input" type="number" value="${item.sets}" style="width: 80px;"></div>
        <div><label>&nbsp;</label><button class="delete-btn">Delete</button></div>
      `;
      
      // Populate exercise dropdown
      const exerciseSelect = row.querySelector('.exercise-select');
      state.exercises.forEach(ex => {
        const option = document.createElement('option');
        option.value = ex.id;
        option.textContent = ex.name;
        if (ex.id === item.exId) option.selected = true;
        exerciseSelect.appendChild(option);
      });
      
      // Add event listeners
      exerciseSelect.onchange = () => {
        item.exId = Number(exerciseSelect.value);
        persist();
      };
      
      row.querySelector('.reps-input').onchange = (e) => {
        item.reps = Number(e.target.value);
        persist();
      };
      
      row.querySelector('.rpe-input').onchange = (e) => {
        item.rpe = Number(e.target.value);
        persist();
      };
      
      row.querySelector('.sets-input').onchange = (e) => {
        item.sets = Number(e.target.value);
        persist();
      };
      
      row.querySelector('.delete-btn').onclick = () => {
        templateItems.splice(index, 1);
        persist();
        renderTemplates();
      };
      
      container.appendChild(row);
    });
  });
}

function renderExercises() {
  const tbody = $('#exTable tbody');
  tbody.innerHTML = '';
  
  state.exercises.forEach(exercise => {
    const row = document.createElement('tr');
    const repRange = getExerciseRepRange(exercise.id);
    row.innerHTML = `
      <td>${exercise.name}</td>
      <td>${exercise.cat}</td>
      <td><input type="number" step="0.5" value="${exercise.tm}" style="width: 100px;"></td>
      <td>${repRange.min}-${repRange.max} reps</td>
      <td><button class="delete-btn">Delete</button></td>
    `;
    
    // Add event listeners
    row.querySelector('input').onchange = (e) => {
      exercise.tm = Number(e.target.value);
      persist();
    };
    
    row.querySelector('.delete-btn').onclick = () => {
      if (confirm('Delete exercise and remove from templates?')) {
        // Remove from templates
        Object.keys(state.templates).forEach(templateKey => {
          state.templates[templateKey] = state.templates[templateKey].filter(item => item.exId !== exercise.id);
        });
        
        // Remove exercise and rep ranges
        state.exercises = state.exercises.filter(ex => ex.id !== exercise.id);
        delete state.exerciseRepRanges[exercise.id];
        
        persist();
        renderExercises();
        renderTemplates();
        renderToday();
      }
    };
    
    tbody.appendChild(row);
  });
}

function renderHistory() {
  const tbody = $('#logTable tbody');
  tbody.innerHTML = '';
  
  // Show last 50 sets
  state.log.slice(0, 50).forEach(set => {
    const exercise = state.exercises.find(ex => ex.id === set.exId);
    const row = document.createElement('tr');
    const date = new Date(set.date);
    
    row.innerHTML = `
      <td>${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</td>
      <td>${exercise?.name || '?'}</td>
      <td>${fmt(set.weight)}×${set.reps}@${set.rpe}</td>
      <td>${set.e1rm.toFixed(1)}</td>
    `;
    
    tbody.appendChild(row);
  });
}

function renderSettings() {
  $('#unit').value = state.unit;
  $('#minJump').value = state.settings.minJump;
  $('#upUpperStrong').value = state.settings.upUpperStrong;
  $('#upUpperSmall').value = state.settings.upUpperSmall;
  $('#downUpper').value = state.settings.downUpper;
  $('#upLowerStrong').value = state.settings.upLowerStrong;
  $('#upLowerSmall').value = state.settings.upLowerSmall;
  $('#downLower').value = state.settings.downLower;
}

function renderRepProgression() {
  renderRepProgressionTable();
  renderRepOverrideTable();
}

function renderRepProgressionTable() {
  const tbody = $('#repProgressionTable tbody');
  tbody.innerHTML = '';
  
  BODY_PARTS.forEach(bodyPart => {
    const row = document.createElement('tr');
    let html = `<td><strong>${bodyPart}</strong></td>`;
    
    for (let week = 1; week <= 6; week++) {
      for (const section of ['A', 'B']) {
        const percentage = getRepPercentageForExercise(week, section, bodyPart);
        const isOverride = state.repProgression.overrides[`${week}-${section}-${bodyPart}`] !== undefined;
        html += `<td class="${isOverride ? 'good' : ''}" style="text-align: center;">
          <input type="number" step="0.1" min="0" max="1" value="${percentage}" 
                 style="width: 60px; text-align: center; ${isOverride ? 'font-weight: bold;' : ''}"
                 onchange="updateRepPercentageFromTable(${week}, '${section}', '${bodyPart}', this.value)">
        </td>`;
      }
    }
    
    row.innerHTML = html;
    tbody.appendChild(row);
  });
}

function renderRepOverrideTable() {
  const tbody = $('#repOverrideTable tbody');
  tbody.innerHTML = '';
  
  const overrides = Object.entries(state.repProgression.overrides).sort();
  
  if (overrides.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="tiny" style="text-align: center;">No custom overrides set. Using default rep percentages.</td></tr>';
    return;
  }
  
  overrides.forEach(([key, percentage]) => {
    const [week, section, bodyPart] = key.split('-');
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${week}</td>
      <td>${section}</td>
      <td>${bodyPart}</td>
      <td>${percentage}</td>
      <td><button onclick="removeRepPercentageOverride('${week}', '${section}', '${bodyPart}'); renderRepProgression();">Remove</button></td>
    `;
    tbody.appendChild(row);
  });
}

function updateRepPercentageFromTable(week, section, bodyPart, value) {
  const percentage = Number(value);
  const defaultPercentage = state.repProgression.defaults[bodyPart] || 0.5;
  
  if (percentage === defaultPercentage) {
    // Remove override if setting back to default
    removeRepPercentageOverride(week, section, bodyPart);
  } else {
    // Set override
    setRepPercentageOverride(week, section, bodyPart, percentage);
  }
  
  // Re-render to update styling
  renderRepProgression();
  
  // Update today view if it's currently showing
  if (!$('#page-today').hidden) {
    renderToday();
  }
}

function renderRPESchedule() {
  renderRPEScheduleTable();
  renderRPEOverrideTable();
}

function renderRPEScheduleTable() {
  const tbody = $('#rpeScheduleTable tbody');
  tbody.innerHTML = '';
  
  BODY_PARTS.forEach(bodyPart => {
    const row = document.createElement('tr');
    let html = `<td><strong>${bodyPart}</strong></td>`;
    
    for (let week = 1; week <= 6; week++) {
      for (const section of ['A', 'B']) {
        const rpe = getRPEForExercise(week, section, bodyPart);
        const isOverride = state.rpeSchedule.overrides[`${week}-${section}-${bodyPart}`] !== undefined;
        html += `<td class="${isOverride ? 'good' : ''}" style="text-align: center;">
          <input type="number" step="0.5" min="6" max="10" value="${rpe}" 
                 style="width: 60px; text-align: center; ${isOverride ? 'font-weight: bold;' : ''}"
                 onchange="updateRPEFromTable(${week}, '${section}', '${bodyPart}', this.value)">
        </td>`;
      }
    }
    
    row.innerHTML = html;
    tbody.appendChild(row);
  });
}

function renderRPEOverrideTable() {
  const tbody = $('#rpeOverrideTable tbody');
  tbody.innerHTML = '';
  
  const overrides = Object.entries(state.rpeSchedule.overrides).sort();
  
  if (overrides.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="tiny" style="text-align: center;">No custom overrides set. Using default RPE values.</td></tr>';
    return;
  }
  
  overrides.forEach(([key, rpe]) => {
    const [week, section, bodyPart] = key.split('-');
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${week}</td>
      <td>${section}</td>
      <td>${bodyPart}</td>
      <td>${rpe}</td>
      <td><button onclick="removeRPEOverride('${week}', '${section}', '${bodyPart}'); renderRPESchedule();">Remove</button></td>
    `;
    tbody.appendChild(row);
  });
}

function updateRPEFromTable(week, section, bodyPart, value) {
  const rpe = Number(value);
  const defaultRPE = state.rpeSchedule.defaults[bodyPart] || 8.0;
  
  if (rpe === defaultRPE) {
    // Remove override if setting back to default
    removeRPEOverride(week, section, bodyPart);
  } else {
    // Set override
    setRPEOverride(week, section, bodyPart, rpe);
  }
  
  // Re-render to update styling
  renderRPESchedule();
  
  // Update today view if it's currently showing
  if (!$('#page-today').hidden) {
    renderToday();
  }
}

/* ---------- Action Functions ---------- */
function addTemplateRow(templateKey) {
  if (!state.templates[templateKey]) {
    state.templates[templateKey] = [];
  }
  
  state.templates[templateKey].push({
    exId: state.exercises[0]?.id || 0,
    reps: 5,
    rpe: 8.5,
    sets: 3
  });
  
  persist();
  renderTemplates();
}

function addExercise() {
  const name = $('#exName').value.trim();
  if (!name) return;
  
  const category = $('#exCat').value;
  const trainingMax = Number($('#exTM').value) || 0;
  const minReps = Number($('#exMinReps').value) || 3;
  const maxReps = Number($('#exMaxReps').value) || 10;
  
  if (minReps >= maxReps) {
    alert('Min reps must be less than max reps');
    return;
  }
  
  const exerciseId = state.nextId++;
  
  state.exercises.push({
    id: exerciseId,
    name: name,
    cat: category,
    tm: trainingMax
  });
  
  // Set rep range for this exercise
  setExerciseRepRange(exerciseId, minReps, maxReps);
  
  // Clear form
  $('#exName').value = '';
  $('#exTM').value = '';
  $('#exMinReps').value = '3';
  $('#exMaxReps').value = '10';
  
  persist();
  renderExercises();
  renderTemplates();
}

function addRPEOverride() {
  const week = $('#newWeek').value;
  const section = $('#newSection').value;
  const bodyPart = $('#newBodyPart').value;
  const rpe = Number($('#newRPE').value);
  
  if (!week || !section || !bodyPart || !rpe) {
    alert('Please fill in all fields');
    return;
  }
  
  setRPEOverride(week, section, bodyPart, rpe);
  renderRPESchedule();
  
  // Clear form
  $('#newRPE').value = '8.0';
}

function addRepPercentageOverride() {
  const week = $('#newRepWeek').value;
  const section = $('#newRepSection').value;
  const bodyPart = $('#newRepBodyPart').value;
  const percentage = Number($('#newRepPercentage').value);
  
  if (!week || !section || !bodyPart || isNaN(percentage)) {
    alert('Please fill in all fields');
    return;
  }
  
  if (percentage < 0 || percentage > 1) {
    alert('Percentage must be between 0.0 and 1.0');
    return;
  }
  
  setRepPercentageOverride(week, section, bodyPart, percentage);
  renderRepProgression();
  
  // Clear form
  $('#newRepPercentage').value = '0.5';
}

function saveSettings() {
  state.unit = $('#unit').value;
  state.settings.minJump = Number($('#minJump').value);
  state.settings.upUpperStrong = Number($('#upUpperStrong').value);
  state.settings.upUpperSmall = Number($('#upUpperSmall').value);
  state.settings.downUpper = Number($('#downUpper').value);
  state.settings.upLowerStrong = Number($('#upLowerStrong').value);
  state.settings.upLowerSmall = Number($('#upLowerSmall').value);
  state.settings.downLower = Number($('#downLower').value);
  
  persist();
  alert('Settings saved!');
}

function closeWeek() {
  state.exercises.forEach(exercise => {
    progressTrainingMax(exercise);
  });
  
  persist();
  alert('Week closed! Training maxes updated.');
  renderExercises();
  renderToday();
}

function resetTemplates() {
  if (confirm('Are you sure you want to reset all templates? This cannot be undone.')) {
    state.templates = JSON.parse(JSON.stringify(DEFAULT_STATE.templates));
    persist();
    renderTemplates();
    alert('Templates reset to default!');
  }
}

function exportData() {
  const dataStr = JSON.stringify(state, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  const link = document.createElement('a');
  link.href = url;
  link.download = `lifttracker-${new Date().toISOString().split('T')[0]}.json`;
  link.click();
  
  URL.revokeObjectURL(url);
}

async function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  try {
    const text = await file.text();
    const importedData = JSON.parse(text);
    
    // Validate imported data structure
    if (importedData && typeof importedData === 'object') {
      Object.assign(state, importedData);
      persist();
      
      // Re-render all views
      renderSettings();
      renderExercises();
      renderTemplates();
      renderToday();
      renderHistory();
      renderRPESchedule();
      renderRepProgression();
      
      alert('Data imported successfully!');
    } else {
      throw new Error('Invalid file format');
    }
  } catch (error) {
    alert('Error importing file: ' + error.message);
  }
  
  // Clear file input
  event.target.value = '';
}

/* ---------- Event Listeners ---------- */
function setupEventListeners() {
  // Week and day changes
  $('#week').onchange = () => {
    updateDayDropdown();
    renderToday();
  };
  
  $('#day').onchange = () => {
    renderToday();
  };
  
  // Unit change
  $('#unit').onchange = () => {
    state.unit = $('#unit').value;
    persist();
    renderToday();
  };
  
  // Advance day button
  $('#advanceBtn').onclick = advanceDay;
  
  // Close week button
  $('#closeWeekBtn').onclick = closeWeek;
  
  // Reset templates button
  $('#resetBtn').onclick = resetTemplates;
  
  // Export button
  $('#exportBtn').onclick = exportData;
  
  // Import file input
  $('#importFile').onchange = importData;
}

/* ---------- Initialization ---------- */
function initialize() {
  // Set up event listeners
  setupEventListeners();
  
  // Initialize day dropdown
  updateDayDropdown();
  
  // Set up tab navigation
  renderTabs();
  
  // Initial render
  renderToday();
  renderTemplates();
  renderExercises();
  renderHistory();
  renderSettings();
  renderRPESchedule();
  renderRepProgression();
}

// Start the app when DOM is loaded
document.addEventListener('DOMContentLoaded', initialize);
</script>
</body>
</html>